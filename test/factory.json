{
  "collection" : {
    "id" : "50424765e4b05fbf2352555a",
    "enabled" : true,
    "starred" : false,
    "type" : 1,
    "ordering" : 2,
    "title" : "Words",
    "navigationTitle" : "Words",
    "urlId" : "words",
    "itemCount" : 219,
    "updatedOn" : 1393011270307,
    "description" : "<p>I write software, take photos, and write on here from time to time.<br />&nbsp;&nbsp;<br />I made an app called&nbsp;<a href=\"http://zartbonk.com\">Zartbonk</a>. It's a soundboard for your iPad.&nbsp;<a href=\"https://itunes.apple.com/us/app/zartbonk/id727445952?ls=1&amp;mt=8\">You should get it.</a></p>",
    "publicCommentCount" : 0,
    "pageSize" : 5,
    "folder" : false,
    "dropdown" : false,
    "tags" : [ "ruby", "apple retail", "code", "objective-c" ],
    "categories" : [ "programming" ],
    "homepage" : true,
    "typeName" : "blog",
    "regionName" : "default",
    "synchronizing" : false,
    "typeLabel" : "blog",
    "fullUrl" : "/",
    "passwordProtected" : false
  },
  "item" : {
    "id" : "5307a834e4b0ebfe8b3ec983",
    "collectionId" : "50424765e4b05fbf2352555a",
    "cloned" : false,
    "recordType" : 1,
    "version" : 1,
    "addedOn" : 1393011245936,
    "updatedOn" : 1393011270303,
    "displayIndex" : 218,
    "starred" : false,
    "passthrough" : false,
    "tags" : [ "ruby", "code" ],
    "workflowState" : 1,
    "publishOn" : 1393011245936,
    "authorId" : "503c2d51c4aaa390413b1114",
    "mediaFocalPoint" : {
      "x" : 0.5,
      "y" : 0.5,
      "source" : 3
    },
    "urlId" : "2014/2/21/demystifying-ruby-dsls-part-2",
    "title" : "Demystifying Ruby DSLs \u2014 Part 2",
    "sourceUrl" : "",
    "body" : "<div class=\"sqs-layout sqs-grid-12 columns-12\" data-type=\"item\" data-updated-on=\"1393011114859\" id=\"item-5307a834e4b0ebfe8b3ec983\"><div class=\"row sqs-row\"><div class=\"col sqs-col-12 span-12\"><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-null\"><div class=\"sqs-block-content\"><p><a href=\"http://blog.swilliams.me/words/2014/1/26/demystifying-ruby-dsls\">Last time we learned about how to use modules to dynamically add functionality to a class</a>. This time let's take a look at doing that, but customizing our extensions at runtime. </p>\n\n<p>What helped me ultimately understand how these things work is that you are building up classes on the fly. It's kind of like when you <code>include</code> a module, it's editing that class to add more methods to it. Think of a bunch of Legos. Each Lego is a module with various methods on it. At runtime they assemble together to build a castle.</p></div></div><div class=\"sqs-block image-block sqs-block-image\" data-block-type=\"5\" id=\"block-54e91cc1bf8249f711eb\"><div class=\"sqs-block-content\">\n\t<div class=\"image-block-outer-wrapper layout-caption-below \">\n\t\n\t\t<div class=\"intrinsic\" style=\"max-width:1000.0px;\">\n\t\t\t\n\t\t\t\t<div style=\"padding-bottom:47.20000076293945%;\" class=\"image-block-wrapper   \" data-description=\"&lt;p&gt;&lt;a href=&quot;http://www.flickr.com/photos/56619626@N05/7406185206/in/photolist-chsCQo-chsDcG-chsCVb-chsD97-chsBY3-chsCeN-chsDid-bgETZB-8FZGC9-9nsJ9P-8oTk1n-dCdMj4-f8b3QR-7J1LqD-7BnYDa-7BnZmZ-7BrJZw-7BrLsb-7BnVLP-9XN1mi-cnFar5-chsCy7-gC3qkX-chsCKW-chsCs1-chsCoN-aCZJqe-aCZJe4-chsCcf-chsC41-aCcgjW-aC9BwX-aCcgf3-aC9BE6-aC9BKr-aCcgUf-aCcgRw-aC9C9v-aCcgXo-chsC7J-chsBZw-a5YVbT-em9rGR-em9ru8-emfdMW-em9tEg-emfewq-emfeEm-emfdxf-emfeh9-emfdi5&quot;&gt;Lego Castle&lt;/a&gt; by &lt;a href=&quot;http://www.flickr.com/photos/skinnylawyer/&quot;&gt;InSapphoWeTrust&lt;/a&gt; on Flickr.&lt;/p&gt;\">\n\t\t\t\t\t<noscript><img src=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a84de4b0ebfe8b3ec9c3/1393010768926/lego%20annotated.png\"  alt=\"Lego Castle by InSapphoWeTrust on Flickr.\"  /></noscript><img class=\"thumb-image\" alt=\"Lego Castle by InSapphoWeTrust on Flickr.\" data-src=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a84de4b0ebfe8b3ec9c3/1393010768926/lego%20annotated.png\" data-image=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a84de4b0ebfe8b3ec9c3/1393010768926/lego%20annotated.png\" data-image-dimensions=\"1000x472\" data-image-focal-point=\"0.5,0.5\" data-load=\"false\" data-image-id=\"5307a84de4b0ebfe8b3ec9c3\" data-type=\"image\" />\n\t\t\t\t</div>\n\t\t\t\n\n\t\t\t\n\t\t\t<div class=\"image-caption-wrapper\">\n\t\t\t\t<div class=\"image-caption\"><p><a href=\"http://www.flickr.com/photos/56619626@N05/7406185206/in/photolist-chsCQo-chsDcG-chsCVb-chsD97-chsBY3-chsCeN-chsDid-bgETZB-8FZGC9-9nsJ9P-8oTk1n-dCdMj4-f8b3QR-7J1LqD-7BnYDa-7BnZmZ-7BrJZw-7BrLsb-7BnVLP-9XN1mi-cnFar5-chsCy7-gC3qkX-chsCKW-chsCs1-chsCoN-aCZJqe-aCZJe4-chsCcf-chsC41-aCcgjW-aC9BwX-aCcgf3-aC9BE6-aC9BKr-aCcgUf-aCcgRw-aC9C9v-aCcgXo-chsC7J-chsBZw-a5YVbT-em9rGR-em9ru8-emfdMW-em9tEg-emfewq-emfeEm-emfdxf-emfeh9-emfdi5\">Lego Castle</a> by <a href=\"http://www.flickr.com/photos/skinnylawyer/\">InSapphoWeTrust</a> on Flickr.</p></div>\n\t\t\t</div>\n\t\t\t\n\n\t\t</div>\n\t\n\t</div>\n</div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-0baca8445cba71dca8fe\"><div class=\"sqs-block-content\"><h3 id=\"dynamicallyadding\">Dynamically Adding</h3>\n\n<p>What if those Legos could generate even more Legos as you were building with them, and then intelligently join themselves together?</p>\n\n<p>If you're familiar with Rails, you've seen that you can just declare associations within a model \u2014 <code>:has_many</code>, <code>:has_one</code>, and so on. Once you add those directives to your class, suddenly you have access to brand spanking new methods. Have you ever wondered how that worked? Let's implement a rudimentary version.</p>\n\n<p>Think for a moment about <code>:has_many</code>. What would you expect the line <code>has_many :gerbils</code> methods to do?  You would have to have a <code>gerbils</code> method to retrieve the little fellas, and another one, <code>gerbils=(new_value)</code> to set them (and others to add them and so on, but <a href=\"http://en.wikipedia.org/wiki/Keep_it_simple_stupid\">KISS</a>). You implement that with a generic <code>get_child_models(child_name)</code> method, but that feels like the Java (\u2122 Oracle Corporation) way... and I have too much self respect to go down that path. Instead we can take advantage of Ruby's metaprogramming capabilities and generate them dynamically. </p>\n\n<p>One way to do this is with <code>eval</code>.</p>\n\n<h2 id=\"awordoneval\">A Word on Eval</h2>\n\n<p>Ruby has a few versions of <code>eval</code>. They all take strings or blocks and turn them in code that is executed.</p>\n\n<ul>\n<li>There's the <a href=\"http://www.ruby-doc.org/core-2.1.0/Kernel.html#method-i-eval\">standard one</a> that executes arbitrary code.</li>\n<li><a href=\"http://ruby-doc.org/core-2.1.0/Module.html#method-i-class_eval\">class_eval</a> \u2014 similar to vanilla <code>eval</code>, but executes the code in the context of the Class itself. There's also <code>module_eval</code> which does the same thing (more or less). Example:</li>\n</ul></div></div><div class=\"sqs-block code-block sqs-block-code\" data-block-type=\"23\" id=\"block-d29e4ab14cf5f6d7dd50\"><div class=\"sqs-block-content\"><pre class=\"source-code\">class Monkey<br>end<br><br>m = Monkey.new<br>Monkey.class_eval %q(def screech() 'Eek Eek' end)<br>m.screech # Eek Eek<br></pre></div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-9023b6c0bbdf7414c983\"><div class=\"sqs-block-content\"><ul>\n<li><a href=\"\">instance_eval</a> \u2014 modifies a class, but from an instance point of view, <em>and only for that particular instance</em> (this is called a <a href=\"http://rubymonk.com/learning/books/4-ruby-primer-ascent/chapters/39-ruby-s-object-model/lessons/131-singleton-methods-and-metaclasses\">Singleton method</a>).</li>\n</ul></div></div><div class=\"sqs-block code-block sqs-block-code\" data-block-type=\"23\" id=\"block-100312a966be1dd11878\"><div class=\"sqs-block-content\"><pre class=\"source-code\">class Monkey<br>end<br><br>m = Monkey.new<br>m2 = Monkey.new<br>m.instance_eval %q(def screech() 'Eek Eek' end)<br>m.screech # Eek Eek<br>m2.screech # NoMethodError: undefined method `screech' for #&lt;Monkey:0x007fa6f768bac8&gt;<br></pre></div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-d180640a9c885c0ba348\"><div class=\"sqs-block-content\"><p>Using these techniques you can generate the set of methods for our <code>:has_many</code> implementation.</p></div></div><div class=\"sqs-block code-block sqs-block-code\" data-block-type=\"23\" id=\"block-16bbd141e48688acbffb\"><div class=\"sqs-block-content\"><pre class=\"source-code\">module Associations<br>  class &lt;&lt; self<br>    def included(base)<br>      base.extend Associations::ClassMethods<br>    end<br>  end<br><br>  module ClassMethods<br>    def has_many(thingies)<br>      code = %(<br>        def #{thingies}<br>          # retrieve stuff from here<br>        end<br><br>        def #{thingies}=(new_value)<br>          # set new_value here<br>        end<br>      )<br>      class_eval code<br>    end<br>  end<br>end<br><br></pre></div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-72745bccad7749044bd1\"><div class=\"sqs-block-content\"><p>Now, if you <code>include Associations</code> in your class, you can call <code>has_many :hamsters</code> or <code>has_many :gerbils</code> or <code>has_many :guinea_pigs</code> and have all of your getters and setters created.</p></div></div><div class=\"sqs-block image-block sqs-block-image\" data-block-type=\"5\" id=\"block-f6cdef880584c044f74f\"><div class=\"sqs-block-content\">\n\t<div class=\"image-block-outer-wrapper layout-caption-below \">\n\t\n\t\t<div class=\"intrinsic\" style=\"max-width:900.0px;\">\n\t\t\t\n\t\t\t\t<div style=\"padding-bottom:50.222225189208984%;\" class=\"image-block-wrapper   \" data-description=\"&lt;p&gt;This is you with all the gerbil methods.&lt;/p&gt;\">\n\t\t\t\t\t<noscript><img src=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a928e4b0bba2c5d78d0d/1393010996562/cashew.jpg\"  alt=\"This is you with all the gerbil methods.\"  /></noscript><img class=\"thumb-image\" alt=\"This is you with all the gerbil methods.\" data-src=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a928e4b0bba2c5d78d0d/1393010996562/cashew.jpg\" data-image=\"http://static.squarespace.com/static/503c2d51c4aaa390413b1112/t/5307a928e4b0bba2c5d78d0d/1393010996562/cashew.jpg\" data-image-dimensions=\"900x452\" data-image-focal-point=\"0.5,0.5\" data-load=\"false\" data-image-id=\"5307a928e4b0bba2c5d78d0d\" data-type=\"image\" />\n\t\t\t\t</div>\n\t\t\t\n\n\t\t\t\n\t\t\t<div class=\"image-caption-wrapper\">\n\t\t\t\t<div class=\"image-caption\"><p>This is you with all the gerbil methods.</p></div>\n\t\t\t</div>\n\t\t\t\n\n\t\t</div>\n\t\n\t</div>\n</div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-84c87ae58dbca460843a\"><div class=\"sqs-block-content\"><h3 id=\"caution\">Caution</h3>\n\n<p>I'm not a big fan of <code>eval</code>, at least when using it with strings. The biggest reason is that it makes bugs harder to find. The Ruby interpreter will point out syntax errors when the file loads, but a typo in an evalled string won't get caught until runtime. The longer the string, the more likely something bad will creep in there. And some of these dynamically created methods will be long. I'm talking <a href=\"http://www.amazon.com/gp/product/B0026L7H20/ref=as_li_ss_tl?ie=UTF8&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B0026L7H20&amp;linkCode=as2&amp;tag=thepetzoo-20\">Lord of the Rings Extended Edition</a> long.</p>\n\n<p>Fortunately there is a better way. The eval methods also take blocks, which work pretty well in most cases. For the purposes of dynamically generating methods, I prefer using <code>define_method</code> (<a href=\"http://ruby-doc.org/core-2.1.0/Module.html#method-i-define_method\">source</a>). It's available on <code>Module</code> (and therefore classes too) and, just like it says on the tin, is designed to create methods on the fly and add them to a class.</p></div></div><div class=\"sqs-block code-block sqs-block-code\" data-block-type=\"23\" id=\"block-3d358c090da3e635fb5a\"><div class=\"sqs-block-content\"><pre class=\"source-code\">def has_many(thingies)<br>  define_method thingies.to_s do<br>    # retrieve stuff from here<br>  end<br><br>  define_method \"#{thingies}=\" do<br>    # set new_value here<br>  end<br>end<br><br></pre></div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-3660391529e660d80c50\"><div class=\"sqs-block-content\"><p>It's kinda similar to the eval code, in fact, <code>define_method</code> passes itself along to <code>instance_eval</code>, so when all is said and done, it's merely for our convenience. But is easier to test, and will complain loudly if there's a syntax error. </p>\n\n<p>Working with actual code rather than a string makes refactoring easier too. Let's say you want to enable your users to define their own implementations of the generated rodent methods. Pulling that out into its own method is simple:</p></div></div><div class=\"sqs-block code-block sqs-block-code\" data-block-type=\"23\" id=\"block-0d57a3a3b97dcadca2a4\"><div class=\"sqs-block-content\"><pre class=\"source-code\">def add_method_without_clobbering (method_name, &amp;method_definition)<br>  unless method_defined? method_name<br>    define_method method_name, method_definition<br>  end<br>end<br><br>def has_many(thingies)<br>  add_method_without_clobbering thingies.to_s do<br>    # retrieve stuff from here<br>  end<br><br>  add_method_without_clobbering \"#{thingies}=\" do<br>    # set new_value here<br>  end<br>end<br><br></pre></div></div><div class=\"sqs-block markdown-block sqs-block-markdown\" data-block-type=\"44\" id=\"block-b7320d52f17d87174233\"><div class=\"sqs-block-content\"><p>That's still possible with string evals, but is easier to read in my eyes.</p>\n\n<p>That'll wrap up this entry on DSLs. There's only one other big piece of the pie I'd like to cover \u2014 blocks, but you can do a whole lot without them.</p>\n\n<p>Oh, and here's a bonus tip too: DSL code can be hard to follow. Document everything, especially the esoteric parts. It might even be a good idea to diagram the path of all the <code>include</code> chain. DSLs can make client code easier to write, but usually at the expense of crazy complexity within the DSL itself.</p></div></div></div></div></div>",
    "excerpt" : "",
    "customContent" : null,
    "likeCount" : 0,
    "dislikeCount" : 0,
    "commentCount" : 0,
    "publicCommentCount" : 0,
    "commentState" : 2,
    "unsaved" : false,
    "author" : {
      "id" : "503c2d51c4aaa390413b1114",
      "lastLoginOn" : 1393010711796,
      "lastActiveOn" : 1393010711796,
      "deleted" : false,
      "personalAccount" : true,
      "isGlobalAdmin" : false,
      "displayName" : "Scott Williams",
      "firstName" : "Scott",
      "lastName" : "Williams",
      "enabled" : true,
      "confirmed" : true,
      "emailVerified" : false,
      "location" : null,
      "revalidateTimestamp" : 0,
      "invitesGiven" : 0,
      "systemGenerated" : false
    },
    "fullUrl" : "/words/2014/2/21/demystifying-ruby-dsls-part-2",
    "assetUrl" : "http://static.squarespace.com/static/503c2d51c4aaa390413b1112/50424765e4b05fbf2352555a/5307a834e4b0ebfe8b3ec983/1393011270303/",
    "contentType" : "text/html",
    "pushedServices" : {
      "twitter-8043162" : true,
      "facebook-572476809" : true
    },
    "recordTypeLabel" : "text"
  },
  "pagination" : {
    "nextItem" : {
      "id" : "52e57c50e4b0f20972c63fb6",
      "collectionId" : "50424765e4b05fbf2352555a",
      "cloned" : false,
      "recordType" : 1,
      "version" : 1,
      "addedOn" : 1390776140205,
      "updatedOn" : 1390784994847,
      "displayIndex" : 217,
      "starred" : false,
      "passthrough" : false,
      "tags" : [ "ruby", "code" ],
      "categories" : [ "programming" ],
      "workflowState" : 1,
      "publishOn" : 1390776140205,
      "authorId" : "503c2d51c4aaa390413b1114",
      "mediaFocalPoint" : {
        "x" : 0.5,
        "y" : 0.5,
        "source" : 3
      },
      "urlId" : "2014/1/26/demystifying-ruby-dsls",
      "title" : "Demystifying Ruby DSLs",
      "sourceUrl" : "",
      "body" : null,
      "excerpt" : "",
      "customContent" : null,
      "likeCount" : 2,
      "dislikeCount" : 0,
      "commentCount" : 0,
      "publicCommentCount" : 0,
      "commentState" : 2,
      "unsaved" : false,
      "author" : {
        "id" : "503c2d51c4aaa390413b1114",
        "lastLoginOn" : 1393010711796,
        "lastActiveOn" : 1393010711796,
        "deleted" : false,
        "personalAccount" : true,
        "isGlobalAdmin" : false,
        "displayName" : "Scott Williams",
        "firstName" : "Scott",
        "lastName" : "Williams",
        "enabled" : true,
        "confirmed" : true,
        "emailVerified" : false,
        "location" : null,
        "revalidateTimestamp" : 0,
        "invitesGiven" : 0,
        "systemGenerated" : false
      },
      "fullUrl" : "/words/2014/1/26/demystifying-ruby-dsls",
      "assetUrl" : "http://static.squarespace.com/static/503c2d51c4aaa390413b1112/50424765e4b05fbf2352555a/52e57c50e4b0f20972c63fb6/1390784994847/",
      "contentType" : "text/html",
      "pushedServices" : {
        "twitter-8043162" : true,
        "facebook-572476809" : true
      },
      "recordTypeLabel" : "text"
    }
  },
  "template" : {
    "mobileStylesEnabled" : true
  },
  "website" : {
    "id" : "503c2d51c4aaa390413b1112",
    "identifier" : "scott-williams",
    "contentModifiedOn" : 1393013472941,
    "cloneable" : false,
    "siteStatus" : { },
    "language" : "en-US",
    "timeZone" : "US/Arizona",
    "machineTimeZoneOffset" : -25200000,
    "timeZoneOffset" : -25200000,
    "timeZoneAbbr" : "MST",
    "siteTitle" : "Scott Williams",
    "siteTagLine" : "Code. Photos. Writing.",
    "siteDescription" : "<p>I write software, take photos, and write on here from time to time.<br />&nbsp;&nbsp;<br />I made an app called <a href=\"http://zartbonk.com\">Zartbonk</a>. It's a soundboard for your iPad. <a href=\"https://itunes.apple.com/us/app/zartbonk/id727445952?ls=1&amp;mt=8\">You should get it.</a></p>",
    "location" : {
      "addressTitle" : "",
      "addressLine1" : "",
      "addressLine2" : "",
      "addressCountry" : ""
    },
    "shareButtonOptions" : {
      "1" : true
    },
    "authenticUrl" : "http://blog.swilliams.me",
    "baseUrl" : "http://blog.swilliams.me",
    "primaryDomain" : "blog.swilliams.me",
    "socialAccounts" : [ {
      "serviceId" : 2,
      "userId" : "572476809",
      "userName" : "scott.t.williams",
      "screenname" : "Scott Williams",
      "addedOn" : 1389667940311,
      "profileUrl" : "http://www.facebook.com/572476809",
      "iconUrl" : "http://graph.facebook.com/572476809/picture?type=square",
      "metaData" : {
        "service" : "facebook"
      },
      "iconEnabled" : true,
      "serviceName" : "facebook"
    } ],
    "statsMigrated" : true
  },
  "websiteSettings" : {
    "id" : "503c2d51c4aaa390413b1113",
    "websiteId" : "503c2d51c4aaa390413b1112",
    "type" : "Business",
    "subject" : "Architecture Services",
    "country" : "US",
    "state" : "AZ",
    "markdownMode" : true,
    "simpleLikingEnabled" : true,
    "lastAgreedTermsOfService" : 2,
    "defaultPostFormat" : "%y/%m/%d/%t",
    "commentLikesAllowed" : false,
    "commentAnonAllowed" : false,
    "commentThreaded" : false,
    "commentApprovalRequired" : true,
    "commentAvatarsOn" : false,
    "commentSortType" : 2,
    "commentFlagThreshold" : 0,
    "commentFlagsAllowed" : false,
    "commentEnableByDefault" : false,
    "commentDisableAfterDaysDefault" : 7,
    "disqusShortname" : "",
    "homepageTitleFormat" : "%s",
    "collectionTitleFormat" : "%c \u2014 %s",
    "itemTitleFormat" : "%i \u2014 %s",
    "commentsEnabled" : false,
    "allowSquarespacePromotion" : true,
    "storeSettings" : {
      "returnPolicy" : null,
      "termsOfService" : null,
      "privacyPolicy" : null,
      "useLightCart" : false,
      "showNoteField" : false,
      "currenciesSupported" : [ "USD" ],
      "defaultCurrency" : "USD",
      "selectedCurrency" : "USD",
      "measurementStandard" : 1,
      "orderConfirmationInjectCode" : "",
      "isLive" : true,
      "stripeConnected" : false,
      "storeState" : 3
    },
    "useEscapeKeyToLogin" : true,
    "ssBadgeType" : 1,
    "ssBadgePosition" : 4,
    "ssBadgeVisibility" : 1,
    "ssBadgeDevices" : 1
  }
}
